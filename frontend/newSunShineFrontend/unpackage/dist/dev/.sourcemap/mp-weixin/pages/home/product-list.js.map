{"version":3,"file":"product-list.js","sources":["pages/home/product-list.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvaG9tZS9wcm9kdWN0LWxpc3QudnVl"],"sourcesContent":["<template>\r\n  <view class=\"page\">\r\n    <!-- 顶部搜索与分类 -->\r\n    <view class=\"top-bar\">\r\n      <view class=\"search-box\">\r\n        <input class=\"search-input\" type=\"text\" v-model=\"keyword\" placeholder=\"搜索商品\" confirm-type=\"search\" @confirm=\"onSearch\" />\r\n        <button class=\"search-btn\" @click=\"onSearch\">搜索</button>\r\n      </view>\r\n    </view>\r\n\r\n    <scroll-view class=\"category-scroll\" scroll-x v-if=\"categories.length\">\r\n      <view :class=\"['cat-chip', activeCategory===cat ? 'active' : '']\" v-for=\"cat in categories\" :key=\"cat\" @click=\"onSelectCategory(cat)\">{{ cat }}</view>\r\n      <view :class=\"['cat-chip', activeCategory==='' ? 'active' : '']\" @click=\"onSelectCategory('')\">全部</view>\r\n    </scroll-view>\r\n\r\n    <!-- 排序行 -->\r\n    <view class=\"sort-row\">\r\n      <picker :value=\"sortIndex\" :range=\"sortOptions\" @change=\"onSortChange\">\r\n        <view class=\"sort-picker\">排序：{{ sortOptions[sortIndex] }}</view>\r\n      </picker>\r\n    </view>\r\n\r\n    <!-- 列表 -->\r\n    <view class=\"product-list\" v-if=\"!loading && products.length\">\r\n      <view class=\"product-card\" v-for=\"item in products\" :key=\"item.id\" @click=\"goDetail(item.id)\">\r\n        <image class=\"cover\" :src=\"item.image || defaultImage\" mode=\"aspectFill\" />\r\n        <view class=\"p-name\">{{ item.name }}</view>\r\n        <view class=\"p-bottom\">\r\n          <text class=\"p-price\">¥ {{ formatPrice(item.price) }}</text>\r\n          <text class=\"p-tag\" v-if=\"item.category\">{{ item.category }}</text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <!-- 加载状态 -->\r\n    <view class=\"loading\" v-if=\"loading\">\r\n      <text>加载中...</text>\r\n    </view>\r\n\r\n    <!-- 空状态 -->\r\n    <view class=\"empty\" v-if=\"!loading && !products.length && !error\">\r\n      <text>暂无商品</text>\r\n      <button class=\"retry-btn\" @click=\"retryLoad\">重新加载</button>\r\n    </view>\r\n\r\n    <!-- 错误状态 -->\r\n    <view class=\"error\" v-if=\"error\">\r\n      <text>{{ error }}</text>\r\n      <button class=\"retry-btn\" @click=\"retryLoad\">重试</button>\r\n    </view>\r\n\r\n    <!-- 底部加载更多 -->\r\n    <view class=\"load-more\" v-if=\"hasMore && !loading && !error\">\r\n      <button class=\"more-btn\" @click=\"loadMore\">加载更多</button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      keyword: '',\r\n      categories: [],\r\n      activeCategory: '',\r\n      products: [],\r\n      page: 1,\r\n      pageSize: 10,\r\n      totalPages: 1,\r\n      loading: false,\r\n      hasMore: false,\r\n      error: '',\r\n      defaultImage: '/static/logo.png',\r\n      sortIndex: 0,\r\n      sortOptions: ['最新', '价格升序', '价格降序'],\r\n      initTimeout: null\r\n    };\r\n  },\r\n  onLoad(query) {\r\n    try {\r\n      console.log('商品列表页开始加载');\r\n      if (query && query.search) {\r\n        this.keyword = decodeURIComponent(query.search);\r\n      }\r\n      this.init();\r\n    } catch (e) {\r\n      console.error('页面加载错误:', e);\r\n      this.error = '页面加载失败';\r\n    }\r\n  },\r\n  onUnload() {\r\n    // 清理定时器\r\n    if (this.initTimeout) {\r\n      clearTimeout(this.initTimeout);\r\n    }\r\n  },\r\n  onReachBottom() {\r\n    if (this.hasMore && !this.loading && !this.error) {\r\n      this.loadMore();\r\n    }\r\n  },\r\n  methods: {\r\n    async init() {\r\n      try {\r\n        this.loading = true;\r\n        this.error = '';\r\n        \r\n        // 设置超时控制\r\n        this.initTimeout = setTimeout(() => {\r\n          this.loading = false;\r\n          this.error = '加载超时，请重试';\r\n        }, 15000); // 15秒超时\r\n\r\n        // 并行加载分类和商品\r\n        await Promise.all([\r\n          this.fetchCategories(),\r\n          this.fetchProducts(true)\r\n        ]);\r\n\r\n        clearTimeout(this.initTimeout);\r\n        console.log('商品列表页初始化完成');\r\n      } catch (e) {\r\n        console.error('初始化失败:', e);\r\n        this.error = '加载失败，请重试';\r\n      } finally {\r\n        this.loading = false;\r\n        if (this.initTimeout) {\r\n          clearTimeout(this.initTimeout);\r\n        }\r\n      }\r\n    },\r\n    async fetchCategories() {\r\n      try {\r\n        const res = await this.$api.products.getCategories();\r\n        const response = res[1] || res;\r\n        if (response && response.statusCode === 200 && response.data && response.data.code === 200) {\r\n          this.categories = response.data.data || [];\r\n        } else {\r\n          console.warn('获取分类失败:', response?.data?.msg);\r\n        }\r\n      } catch (e) {\r\n        console.error('获取分类错误:', e);\r\n        // 分类失败不影响主流程\r\n      }\r\n    },\r\n    async fetchProducts(reset = false) {\r\n      if (reset) {\r\n        this.page = 1;\r\n        this.products = [];\r\n      }\r\n      \r\n      this.loading = true;\r\n      this.error = '';\r\n      \r\n      try {\r\n        const { keyword, activeCategory, page, pageSize, sortIndex } = this;\r\n        let sortBy = 'created_at';\r\n        let sortOrder = 'DESC';\r\n        if (sortIndex === 1) { sortBy = 'price'; sortOrder = 'ASC'; }\r\n        if (sortIndex === 2) { sortBy = 'price'; sortOrder = 'DESC'; }\r\n\r\n        const params = {\r\n          page,\r\n          pageSize,\r\n          search: keyword,\r\n          category: activeCategory,\r\n          sortBy,\r\n          sortOrder\r\n        };\r\n\r\n        console.log('请求商品列表参数:', params);\r\n        const res = await this.$api.products.getProducts(params);\r\n        const response = res[1] || res;\r\n        \r\n        if (response && response.statusCode === 200 && response.data && response.data.code === 200) {\r\n          const { list, pagination } = response.data.data || {};\r\n          this.products = this.products.concat(list || []);\r\n          this.totalPages = (pagination && pagination.totalPages) || 1;\r\n          this.hasMore = this.page < this.totalPages;\r\n          console.log('商品列表加载成功，共', this.products.length, '个商品');\r\n        } else {\r\n          throw new Error(response?.data?.msg || '获取商品列表失败');\r\n        }\r\n      } catch (e) {\r\n        console.error('获取商品列表错误:', e);\r\n        this.error = e.message || '获取商品列表失败';\r\n        if (reset) {\r\n          this.products = [];\r\n        }\r\n      } finally {\r\n        this.loading = false;\r\n      }\r\n    },\r\n    onSearch() {\r\n      this.fetchProducts(true);\r\n    },\r\n    onSelectCategory(cat) {\r\n      this.activeCategory = cat;\r\n      this.fetchProducts(true);\r\n    },\r\n    onSortChange(e) {\r\n      this.sortIndex = Number(e.detail.value || 0);\r\n      this.fetchProducts(true);\r\n    },\r\n    loadMore() {\r\n      if (this.hasMore && !this.loading && !this.error) {\r\n        this.page += 1;\r\n        this.fetchProducts(false);\r\n      }\r\n    },\r\n    retryLoad() {\r\n      this.error = '';\r\n      this.init();\r\n    },\r\n    goDetail(id) {\r\n      try {\r\n        this.$router.navigateTo(`/pages/home/product-detail?id=${id}`);\r\n      } catch (e) {\r\n        console.error('跳转详情页失败:', e);\r\n        uni.showToast({ title: '跳转失败', icon: 'none' });\r\n      }\r\n    },\r\n    formatPrice(v) {\r\n      const n = Number(v || 0);\r\n      return n.toFixed(2);\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.page { background: #f5f5f5; min-height: 100vh; }\r\n.top-bar { display: flex; align-items: center; padding: 24rpx 24rpx 0 24rpx; }\r\n.search-box { flex: 1; display: flex; background: #ffffff; border-radius: 999rpx; padding: 8rpx 8rpx 8rpx 24rpx; }\r\n.search-input { flex: 1; font-size: 28rpx; }\r\n.search-btn { margin-left: 8rpx; background: #07c160; color: #fff; border-radius: 999rpx; font-size: 26rpx; padding: 0 24rpx; }\r\n.category-scroll { white-space: nowrap; margin: 8rpx 24rpx; }\r\n.cat-chip { display: inline-block; padding: 10rpx 20rpx; margin-right: 12rpx; background: #ffffff; border-radius: 999rpx; font-size: 24rpx; color: #333; }\r\n.cat-chip.active { background: #07c160; color: #fff; }\r\n.sort-row { margin: 8rpx 24rpx; }\r\n.sort-picker { background: #fff; border-radius: 12rpx; padding: 20rpx; color: #333; font-size: 26rpx; }\r\n.product-list { margin: 12rpx 24rpx 24rpx 24rpx; display: grid; grid-template-columns: repeat(2, 1fr); grid-gap: 16rpx; }\r\n.product-card { background: #fff; border-radius: 12rpx; overflow: hidden; padding-bottom: 12rpx; }\r\n.cover { width: 100%; height: 300rpx; background: #f0f0f0; }\r\n.p-name { font-size: 26rpx; color: #111; padding: 12rpx 12rpx 4rpx 12rpx; line-height: 36rpx; height: 72rpx; overflow: hidden; }\r\n.p-bottom { display: flex; align-items: center; justify-content: space-between; padding: 0 12rpx; }\r\n.p-price { color: #e33; font-weight: bold; }\r\n.p-tag { font-size: 22rpx; color: #999; }\r\n.loading, .empty, .error, .load-more { text-align: center; color: #666; padding: 24rpx 0; }\r\n.error { color: #e33; }\r\n.retry-btn { background: #07c160; color: #fff; border-radius: 999rpx; font-size: 26rpx; padding: 8rpx 24rpx; margin-top: 12rpx; }\r\n.more-btn { background: #07c160; color: #fff; border-radius: 999rpx; font-size: 26rpx; padding: 0 36rpx; }\r\n</style>\r\n","import MiniProgramPage from 'D:/newSunShinestore/frontend/newSunShineFrontend/pages/home/product-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni"],"mappings":"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"}